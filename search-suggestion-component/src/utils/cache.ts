/**
 * LRUç¼“å­˜å®ç°
 * LRU = Least Recently Usedï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
 * 
 * åŸç†ï¼š
 * - ç¼“å­˜æœ‰å®¹é‡é™åˆ¶ï¼ˆmaxSizeï¼‰
 * - å½“ç¼“å­˜æ»¡æ—¶ï¼Œåˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„é¡¹
 * - æ¯æ¬¡è®¿é—®éƒ½ä¼šæ›´æ–°è¯¥é¡¹çš„"æœ€è¿‘ä½¿ç”¨"æ—¶é—´
 */

// ============================================================
// ğŸ¯ ã€ç»ƒæ‰‹ä»»åŠ¡3ã€‘å®ç°LRUç¼“å­˜æœºåˆ¶
// ============================================================

/**
 * LRUç¼“å­˜ç±»
 * @example
 * const cache = new LRUCache<string, number>(3)
 * cache.set('a', 1)
 * cache.set('b', 2)
 * cache.set('c', 3)
 * cache.set('d', 4) // è¿™æ—¶ä¼šåˆ é™¤'a'ï¼ˆæœ€ä¹…æœªä½¿ç”¨ï¼‰
 */
export class LRUCache<K, V> {
  // ============================================================
  // ğŸ“Œ ç¬¬1æ­¥ï¼šå®šä¹‰ç±»çš„å±æ€§
  // ============================================================
  // è§£é‡Šï¼šéœ€è¦ä¸¤ä¸ªå±æ€§
  //   1. maxSize: æœ€å¤§å®¹é‡
  //   2. cache: å­˜å‚¨æ•°æ®çš„Map
  //
  // ä¸ºä»€ä¹ˆç”¨Mapï¼Ÿ
  //   - Mapåœ¨JavaScriptä¸­ä¿æŒæ’å…¥é¡ºåº
  //   - keys()ä¼šæŒ‰ç…§æ’å…¥é¡ºåºè¿”å›
  //   - ç¬¬ä¸€ä¸ªkeyå°±æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„
  
  private maxSize: number
  private cache: Map<K, V>  // ğŸ‘ˆ ä½¿ç”¨Mapå­˜å‚¨æ•°æ®
  
  // ============================================================
  // ğŸ“Œ ç¬¬2æ­¥ï¼šå®ç°æ„é€ å‡½æ•°
  // ============================================================
  /**
   * æ„é€ å‡½æ•°
   * @param maxSize æœ€å¤§ç¼“å­˜å®¹é‡ï¼ˆé»˜è®¤100ï¼‰
   */
  constructor(maxSize: number = 100) {
    // ğŸ‘‰ ä½ çš„ä»£ç ï¼šåˆå§‹åŒ–å±æ€§
    // 
    // æ­¥éª¤ï¼š
    //   1. å°†maxSizeå‚æ•°èµ‹å€¼ç»™this.maxSize
    //   2. åˆ›å»ºä¸€ä¸ªæ–°çš„Mapèµ‹å€¼ç»™this.cache
    //
    // ä»£ç ç¤ºä¾‹ï¼š
    //   this.maxSize = maxSize
    //   this.cache = new Map<K, V>()
    
    // å†™åœ¨è¿™é‡Œï¼š
    this.maxSize = maxSize
    this.cache = new Map<K, V>()
    
    // âœ… å®Œæˆï¼ç°åœ¨ç¼“å­˜å·²ç»åˆå§‹åŒ–å¥½äº†
  }
  
  // ============================================================
  // ğŸ“Œ ç¬¬3æ­¥ï¼šå®ç°getæ–¹æ³•ï¼ˆè·å–ç¼“å­˜ï¼‰
  // ============================================================
  /**
   * è·å–ç¼“å­˜å€¼
   * æ³¨æ„ï¼šè®¿é—®åè¦æ›´æ–°è¯¥é¡¹çš„é¡ºåºï¼ˆç§»åˆ°æœ€åï¼‰
   * 
   * @param key ç¼“å­˜é”®
   * @returns ç¼“å­˜å€¼ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›undefined
   */
  get(key: K): V | undefined {
    // ============================================================
    // å®ç°æ€è·¯ï¼š
    // ============================================================
    // 1. æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨
    //    - å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›undefined
    // 2. å¦‚æœå­˜åœ¨ï¼š
    //    - è·å–value
    //    - åˆ é™¤æ—§çš„entryï¼ˆè¿™æ ·æ‰èƒ½é‡æ–°æ’å…¥åˆ°æœ€åï¼‰
    //    - é‡æ–°setï¼ˆæ’å…¥åˆ°Mapçš„æœ€åï¼Œè¡¨ç¤ºæœ€è¿‘ä½¿ç”¨ï¼‰
    //    - è¿”å›value
    //
    // ä¸ºä»€ä¹ˆè¦"åˆ é™¤å†æ’å…¥"ï¼Ÿ
    //   å› ä¸ºMapä¿æŒæ’å…¥é¡ºåºï¼Œé‡æ–°æ’å…¥ä¼šè®©è¿™ä¸ªkeyå˜æˆ"æœ€æ–°çš„"
    // ============================================================
    
    // ğŸ‘‰ æ­¥éª¤1ï¼šæ£€æŸ¥keyæ˜¯å¦å­˜åœ¨
    // ä½¿ç”¨ï¼šthis.cache.has(key)
    if (!this.cache.has(key)) {
      return undefined  // ä¸å­˜åœ¨ï¼Œè¿”å›undefined
    }
    
    // ğŸ‘‰ æ­¥éª¤2ï¼šè·å–value
    // ä½¿ç”¨ï¼šthis.cache.get(key)
    // æ³¨æ„ï¼šå› ä¸ºä¸Šé¢å·²ç»æ£€æŸ¥äº†hasï¼Œæ‰€ä»¥å¯ä»¥ç”¨ ! æ–­è¨€éç©º
    const value = this.cache.get(key)!
    
    // ğŸ‘‰ æ­¥éª¤3ï¼šåˆ é™¤æ—§çš„entry
    // ä½¿ç”¨ï¼šthis.cache.delete(key)
    this.cache.delete(key)
    
    // ğŸ‘‰ æ­¥éª¤4ï¼šé‡æ–°æ’å…¥ï¼ˆç§»åˆ°æœ€å = æœ€è¿‘ä½¿ç”¨ï¼‰
    // ä½¿ç”¨ï¼šthis.cache.set(key, value)
    this.cache.set(key, value)
    
    // ğŸ‘‰ æ­¥éª¤5ï¼šè¿”å›value
    return value
    
    // ============================================================
    // âœ… å®Œæˆï¼ç°åœ¨getæ–¹æ³•ä¼šè‡ªåŠ¨æ›´æ–°è®¿é—®é¡ºåº
    // ============================================================
    // æµ‹è¯•ï¼š
    //   cache.set('a', 1)
    //   cache.set('b', 2)
    //   cache.get('a')  // è®¿é—®aï¼Œaä¼šç§»åˆ°æœ€å
    //   // ç°åœ¨é¡ºåºæ˜¯ï¼šb, aï¼ˆaæœ€è¿‘ä½¿ç”¨ï¼‰
    // ============================================================
  }
  
  // ============================================================
  // ğŸ“Œ ç¬¬4æ­¥ï¼šå®ç°setæ–¹æ³•ï¼ˆè®¾ç½®ç¼“å­˜ï¼‰
  // ============================================================
  /**
   * è®¾ç½®ç¼“å­˜å€¼
   * æ³¨æ„ï¼š
   * - å¦‚æœkeyå·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤ï¼ˆæ›´æ–°é¡ºåºï¼‰
   * - å¦‚æœç¼“å­˜æ»¡äº†ï¼Œåˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„é¡¹ï¼ˆç¬¬ä¸€ä¸ªï¼‰
   * 
   * @param key ç¼“å­˜é”®
   * @param value ç¼“å­˜å€¼
   */
  set(key: K, value: V): void {
    // ============================================================
    // å®ç°æ€è·¯ï¼š
    // ============================================================
    // 1. å¦‚æœkeyå·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤ï¼ˆè¿™æ ·é‡æ–°setæ—¶ä¼šç§»åˆ°æœ€åï¼‰
    // 2. è®¾ç½®æ–°å€¼
    // 3. æ£€æŸ¥ç¼“å­˜å¤§å°ï¼š
    //    - å¦‚æœè¶…è¿‡maxSizeï¼Œåˆ é™¤ç¬¬ä¸€ä¸ªkeyï¼ˆæœ€ä¹…æœªä½¿ç”¨ï¼‰
    // ============================================================
    
    // ğŸ‘‰ æ­¥éª¤1ï¼šå¦‚æœkeyå·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
    // 
    // ä¸ºä»€ä¹ˆè¦åˆ é™¤ï¼Ÿ
    //   ç¡®ä¿é‡æ–°æ’å…¥æ—¶åœ¨æœ€åï¼ˆæœ€è¿‘ä½¿ç”¨çš„ä½ç½®ï¼‰
    //
    // ä»£ç ï¼š
    //   if (this.cache.has(key)) {
    //     this.cache.delete(key)
    //   }
    
    // å†™åœ¨è¿™é‡Œï¼š
    if (this.cache.has(key)) {
      this.cache.delete(key)
    }
    
    // ğŸ‘‰ æ­¥éª¤2ï¼šè®¾ç½®æ–°å€¼
    // ä½¿ç”¨ï¼šthis.cache.set(key, value)
    this.cache.set(key, value)
    
    // ğŸ‘‰ æ­¥éª¤3ï¼šæ£€æŸ¥å®¹é‡ï¼Œå¦‚æœè¶…è¿‡maxSizeåˆ™åˆ é™¤æœ€æ—§çš„
    //
    // å¦‚ä½•è·å–æœ€æ—§çš„keyï¼Ÿ
    //   - Map.keys()è¿”å›æŒ‰æ’å…¥é¡ºåºçš„è¿­ä»£å™¨
    //   - ç¬¬ä¸€ä¸ªkeyå°±æ˜¯æœ€æ—§çš„
    //   - ä½¿ç”¨ï¼šthis.cache.keys().next().value
    //
    // ä»£ç æ¡†æ¶ï¼š
    //   if (this.cache.size > this.maxSize) {
    //     const oldestKey = this.cache.keys().next().value
    //     this.cache.delete(oldestKey)
    //   }
    
    // å†™åœ¨è¿™é‡Œï¼š
    if (this.cache.size > this.maxSize) {
      // è·å–ç¬¬ä¸€ä¸ªkeyï¼ˆæœ€ä¹…æœªä½¿ç”¨ï¼‰
      const oldestKey = this.cache.keys().next().value
      // åˆ é™¤å®ƒ
      this.cache.delete(oldestKey)
    }
    
    // ============================================================
    // âœ… å®Œæˆï¼LRUç¼“å­˜å·²ç»å¯ä»¥å·¥ä½œäº†
    // ============================================================
    // å·¥ä½œåŸç†ç¤ºä¾‹ï¼š
    //   const cache = new LRUCache<string, number>(3)
    //   
    //   cache.set('a', 1)  // ç¼“å­˜ï¼š[a]
    //   cache.set('b', 2)  // ç¼“å­˜ï¼š[a, b]
    //   cache.set('c', 3)  // ç¼“å­˜ï¼š[a, b, c]
    //   cache.set('d', 4)  // ç¼“å­˜æ»¡äº†ï¼åˆ é™¤aï¼Œç¼“å­˜ï¼š[b, c, d]
    //   
    //   cache.get('b')     // è®¿é—®bï¼Œbç§»åˆ°æœ€åï¼Œç¼“å­˜ï¼š[c, d, b]
    //   cache.set('e', 5)  // ç¼“å­˜æ»¡äº†ï¼åˆ é™¤cï¼Œç¼“å­˜ï¼š[d, b, e]
    // ============================================================
  }
  
  // ============================================================
  // ğŸ“Œ ç¬¬5æ­¥ï¼šå®ç°è¾…åŠ©æ–¹æ³•ï¼ˆå·²å®Œæˆï¼‰
  // ============================================================
  
  /**
   * æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨
   */
  has(key: K): boolean {
    return this.cache.has(key)
  }
  
  /**
   * åˆ é™¤æŒ‡å®škey
   */
  delete(key: K): boolean {
    return this.cache.delete(key)
  }
  
  /**
   * æ¸…ç©ºç¼“å­˜
   */
  clear(): void {
    this.cache.clear()
  }
  
  /**
   * è·å–ç¼“å­˜å¤§å°
   */
  get size(): number {
    return this.cache.size
  }
  
  /**
   * è·å–æ‰€æœ‰keys
   */
  keys(): IterableIterator<K> {
    return this.cache.keys()
  }
  
  /**
   * è·å–æ‰€æœ‰values
   */
  values(): IterableIterator<V> {
    return this.cache.values()
  }
}

// ============================================================
// âœ… å…¨éƒ¨å®Œæˆï¼æµ‹è¯•ä½ çš„LRUç¼“å­˜
// ============================================================
// åœ¨æµè§ˆå™¨consoleä¸­æµ‹è¯•ï¼š
//
//   const cache = new LRUCache<string, number>(3)
//   
//   cache.set('a', 1)
//   cache.set('b', 2)
//   cache.set('c', 3)
//   console.log(cache.size)  // 3
//   
//   cache.set('d', 4)  // è¶…è¿‡å®¹é‡ï¼Œåˆ é™¤'a'
//   console.log(cache.has('a'))  // false
//   console.log(cache.size)  // 3
//   
//   cache.get('b')  // è®¿é—®'b'ï¼Œ'b'å˜æˆæœ€è¿‘ä½¿ç”¨
//   cache.set('e', 5)  // è¶…è¿‡å®¹é‡ï¼Œåˆ é™¤'c'ï¼ˆä¸æ˜¯'b'ï¼‰
//   console.log(cache.has('c'))  // false
//   console.log(cache.has('b'))  // true
//
// ============================================================
// ğŸ’¡ LRUç¼“å­˜çš„åº”ç”¨åœºæ™¯ï¼š
// ============================================================
// 1. æœç´¢ç»“æœç¼“å­˜ï¼š
//    cache.set(keyword, results)
//    ä¸‹æ¬¡æœç´¢ç›¸åŒå…³é”®è¯æ—¶ç›´æ¥è¿”å›
//
// 2. å›¾ç‰‡ç¼“å­˜ï¼š
//    cache.set(imageUrl, imageData)
//    é¿å…é‡å¤ä¸‹è½½
//
// 3. APIå“åº”ç¼“å­˜ï¼š
//    cache.set(apiUrl, response)
//    å‡å°‘ç½‘ç»œè¯·æ±‚
// ============================================================

