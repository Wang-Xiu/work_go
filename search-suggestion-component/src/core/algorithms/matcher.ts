import { MatchType } from '../../types'
import { PinyinUtil } from '../../utils/pinyin'

/**
 * åŒ¹é…ç®—æ³•æ¨¡å—
 * è´Ÿè´£åˆ¤æ–­æœç´¢å…³é”®è¯ä¸å»ºè®®é¡¹çš„åŒ¹é…ç¨‹åº¦
 */

/**
 * å‰ç¼€åŒ¹é…
 * æœ€é«˜ä¼˜å…ˆçº§ï¼Œå®Œå…¨åŒ¹é…å¼€å¤´
 * @example prefixMatch("iPhone", "iph") => true
 */
export function prefixMatch(text: string, keyword: string): boolean {
  return text.toLowerCase().startsWith(keyword.toLowerCase())
}

/**
 * åŒ…å«åŒ¹é…
 * åˆ¤æ–­æ–‡æœ¬æ˜¯å¦åŒ…å«å…³é”®è¯
 * @example containsMatch("MacBook Pro", "book") => true
 */
export function containsMatch(text: string, keyword: string): boolean {
  return text.toLowerCase().includes(keyword.toLowerCase())
}

/**
 * æ‹¼éŸ³åŒ¹é…
 * æ”¯æŒä¸­æ–‡æ‹¼éŸ³æœç´¢
 * @example pinyinMatch("è‹¹æœæ‰‹æœº", "pingguo") => true
 */
export function pinyinMatch(text: string, keyword: string): boolean {
  return PinyinUtil.matchPinyin(text, keyword)
}

/**
 * æ‹¼éŸ³é¦–å­—æ¯åŒ¹é…
 * æ”¯æŒæ‹¼éŸ³é¦–å­—æ¯ç¼©å†™æœç´¢
 * @example pinyinFirstMatch("è‹¹æœæ‰‹æœº", "pgsj") => true
 */
export function pinyinFirstMatch(text: string, keyword: string): boolean {
  return PinyinUtil.matchPinyinFirst(text, keyword)
}

// ============================================================
// ğŸ¯ ã€ç»ƒæ‰‹ä»»åŠ¡1ã€‘å®ç°æ¨¡ç³ŠåŒ¹é…ç®—æ³•
// ============================================================

/**
 * æ¨¡ç³ŠåŒ¹é…ç®—æ³•ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
 * å…è®¸å…³é”®è¯ä¸­çš„å­—ç¬¦åœ¨æ–‡æœ¬ä¸­ä¸è¿ç»­å‡ºç°
 * ä¾‹å¦‚ï¼šè¾“å…¥"iph"å¯ä»¥åŒ¹é…"iPhone"
 * 
 * æ€§èƒ½ä¼˜åŒ–ï¼š
 * - æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­nä¸ºtexté•¿åº¦ï¼ˆå•æ¬¡éå†ï¼‰
 * - ç©ºé—´å¤æ‚åº¦ï¼šO(k)ï¼Œå…¶ä¸­kä¸ºkeywordé•¿åº¦ï¼ˆå­˜å‚¨åŒ¹é…ä½ç½®ï¼‰
 * - å¿«é€Ÿè·¯å¾„ï¼šå¯¹äºå®Œç¾åŒ¹é…æå‰è¿”å›
 * 
 * @param text è¦åŒ¹é…çš„æ–‡æœ¬
 * @param keyword æœç´¢å…³é”®è¯
 * @returns åŒ¹é…å¾—åˆ† 0-100ï¼ˆæ•°å­—è¶Šå¤§è¡¨ç¤ºåŒ¹é…åº¦è¶Šé«˜ï¼‰
 */
export function fuzzyMatch(text: string, keyword: string): number {
  // ============================================================
  // ğŸ“ å®ç°æ­¥éª¤è¯´æ˜ï¼š
  // ============================================================
  // 
  // è¿™ä¸ªå‡½æ•°çš„ç›®æ ‡æ˜¯ï¼šåˆ¤æ–­keywordä¸­çš„æ¯ä¸ªå­—ç¬¦æ˜¯å¦èƒ½åœ¨textä¸­
  // æŒ‰é¡ºåºæ‰¾åˆ°ï¼ˆå¯ä»¥è·³è¿‡ä¸­é—´çš„å­—ç¬¦ï¼‰
  //
  // ä¾‹å¦‚ï¼š
  //   text = "iPhone 15 Pro"
  //   keyword = "iph"
  //   
  //   åœ¨textä¸­æŸ¥æ‰¾ï¼š
  //   i -> æ‰¾åˆ°ï¼ˆä½ç½®0ï¼‰
  //   p -> æ‰¾åˆ°ï¼ˆä½ç½®1ï¼‰
  //   h -> æ‰¾åˆ°ï¼ˆä½ç½®2ï¼‰
  //   
  //   æ‰€ä»¥åŒ¹é…æˆåŠŸï¼Œè¿”å› 100ï¼ˆå®Œå…¨åŒ¹é…ï¼‰
  //
  // åˆå¦‚ï¼š
  //   text = "MacBook Pro"
  //   keyword = "mbp"
  //   
  //   åœ¨textä¸­æŸ¥æ‰¾ï¼š
  //   m -> æ‰¾åˆ°ï¼ˆä½ç½®0ï¼‰
  //   b -> æ‰¾åˆ°ï¼ˆä½ç½®3ï¼‰
  //   p -> æ‰¾åˆ°ï¼ˆä½ç½®8ï¼‰
  //   
  //   æ‰€ä»¥åŒ¹é…æˆåŠŸï¼Œè¿”å› 100
  //
  // ============================================================
  // ğŸ“Œ ç¬¬1æ­¥ï¼šå‚æ•°é¢„å¤„ç†
  // ============================================================
  // æç¤ºï¼šå°†textå’Œkeywordéƒ½è½¬ä¸ºå°å†™ï¼Œæ–¹ä¾¿æ¯”è¾ƒ
  // ä»£ç ç¤ºä¾‹ï¼š
  //   const lowerText = text.toLowerCase()
  //   const lowerKeyword = keyword.toLowerCase()
  
  // ğŸ‘‰ ä½ çš„ä»£ç ï¼šåœ¨è¿™é‡Œè½¬æ¢ä¸ºå°å†™
  const lowerText = text.toLowerCase()
  const lowerKeyword = keyword.toLowerCase()
  
  // ============================================================
  // ğŸ“Œ ç¬¬2æ­¥ï¼šè¾¹ç•Œæ¡ä»¶æ£€æŸ¥
  // ============================================================
  // æç¤ºï¼š
  // - å¦‚æœkeywordä¸ºç©ºï¼Œè¿”å›0ï¼ˆæ²¡æœ‰è¾“å…¥ï¼Œä¸åŒ¹é…ï¼‰
  // - å¦‚æœtextä¸ºç©ºï¼Œè¿”å›0ï¼ˆæ–‡æœ¬ä¸ºç©ºï¼Œæ— æ³•åŒ¹é…ï¼‰
  // - å¦‚æœkeywordæ¯”textè¿˜é•¿ï¼Œè¿”å›0ï¼ˆä¸å¯èƒ½åŒ¹é…ï¼‰
  
  // ğŸ‘‰ ä½ çš„ä»£ç ï¼šåœ¨è¿™é‡Œæ£€æŸ¥è¾¹ç•Œæ¡ä»¶
  if (!lowerKeyword || !lowerText) return 0
  if (lowerKeyword.length > lowerText.length) return 0
  
  // ============================================================
  // ğŸ“Œ ç¬¬3æ­¥ï¼šä½¿ç”¨åŒæŒ‡é’ˆç®—æ³•è¿›è¡ŒåŒ¹é…
  // ============================================================
  // è§£é‡Šï¼šä»€ä¹ˆæ˜¯åŒæŒ‡é’ˆï¼Ÿ
  //   - textIndexï¼šæŒ‡å‘textçš„å½“å‰ä½ç½®
  //   - keywordIndexï¼šæŒ‡å‘keywordçš„å½“å‰ä½ç½®
  //   - ä»å·¦åˆ°å³æ‰«æï¼Œå¦‚æœå­—ç¬¦åŒ¹é…å°±ç§»åŠ¨keywordæŒ‡é’ˆ
  //
  // ç®—æ³•æµç¨‹ï¼š
  //   1. textIndexä»0å¼€å§‹éå†textçš„æ¯ä¸ªå­—ç¬¦
  //   2. å¦‚æœtext[textIndex] == keyword[keywordIndex]
  //      -> æ‰¾åˆ°åŒ¹é…ï¼ŒkeywordIndex++ï¼ŒmatchCount++
  //   3. ç»§ç»­éå†ï¼Œç›´åˆ°keywordå…¨éƒ¨åŒ¹é…å®Œæˆ–textéå†å®Œ
  //   4. æœ€åè®¡ç®—åŒ¹é…ç‡
  
  // ğŸ‘‰ ä½ çš„ä»£ç ï¼šå®šä¹‰å˜é‡
  // æç¤ºï¼šéœ€è¦å®šä¹‰ä¸‰ä¸ªå˜é‡
  //   - textIndex: number = 0ï¼ˆtextçš„ç´¢å¼•ï¼‰
  //   - keywordIndex: number = 0ï¼ˆkeywordçš„ç´¢å¼•ï¼‰
  //   - matchCount: number = 0ï¼ˆå·²åŒ¹é…çš„å­—ç¬¦æ•°ï¼‰
  
  // å†™åœ¨è¿™é‡Œï¼š
  let textIndex = 0
  let keywordIndex = 0
  let matchCount = 0
  
  // ============================================================
  // ğŸ“Œ ç¬¬4æ­¥ï¼šç¼–å†™whileå¾ªç¯è¿›è¡ŒåŒ¹é…
  // ============================================================
  // ğŸ‘‰ ä½ çš„ä»£ç ï¼šå®Œæˆwhileå¾ªç¯
  // 
  // å¾ªç¯æ¡ä»¶ï¼š
  //   while (textIndex < lowerText.length && keywordIndex < lowerKeyword.length)
  //
  // å¾ªç¯ä½“å†…çš„é€»è¾‘ï¼š
  //   1. æ¯”è¾ƒ lowerText[textIndex] å’Œ lowerKeyword[keywordIndex]
  //   2. å¦‚æœç›¸ç­‰ï¼š
  //      - matchCount++ï¼ˆåŒ¹é…æ•°+1ï¼‰
  //      - keywordIndex++ï¼ˆkeywordæŒ‡é’ˆåç§»ï¼‰
  //   3. æ— è®ºæ˜¯å¦åŒ¹é…ï¼ŒtextIndexéƒ½è¦++ï¼ˆtextæŒ‡é’ˆåç§»ï¼‰
  //
  // ä»£ç æ¡†æ¶ï¼š
  //   while (å¾ªç¯æ¡ä»¶) {
  //     if (å­—ç¬¦ç›¸ç­‰) {
  //       matchCount++
  //       keywordIndex++
  //     }
  //     textIndex++
  //   }
  
  // å†™åœ¨è¿™é‡Œï¼š
  while (textIndex < lowerText.length && keywordIndex < lowerKeyword.length) {
    if (lowerText[textIndex] === lowerKeyword[keywordIndex]) {
      matchCount++
      keywordIndex++
    }
    textIndex++
  }
  
  // ============================================================
  // ğŸ“Œ ç¬¬5æ­¥ï¼šè®¡ç®—åŒ¹é…å¾—åˆ†
  // ============================================================
  // è§£é‡Šï¼š
  //   - å¦‚æœmatchCount < keyword.lengthï¼Œè¯´æ˜æ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œè¿”å›0
  //   - å¦‚æœå®Œå…¨åŒ¹é…ï¼Œè®¡ç®—å¾—åˆ†ï¼š
  //     å¾—åˆ† = (åŒ¹é…å­—ç¬¦æ•° / å…³é”®è¯é•¿åº¦) Ã— 100
  //
  // ä¾‹å¦‚ï¼š
  //   keyword = "iph"ï¼ˆé•¿åº¦3ï¼‰
  //   matchCount = 3ï¼ˆå…¨éƒ¨åŒ¹é…ï¼‰
  //   å¾—åˆ† = (3 / 3) Ã— 100 = 100
  
  // ğŸ‘‰ ä½ çš„ä»£ç ï¼šè®¡ç®—å¹¶è¿”å›å¾—åˆ†
  // 
  // æ­¥éª¤1ï¼šåˆ¤æ–­æ˜¯å¦å®Œå…¨åŒ¹é…
  //   if (matchCount < lowerKeyword.length) {
  //     return 0  // æ²¡æœ‰å®Œå…¨åŒ¹é…
  //   }
  //
  // æ­¥éª¤2ï¼šè®¡ç®—å¾—åˆ†
  //   return (matchCount / lowerKeyword.length) * 100
  
  // å†™åœ¨è¿™é‡Œï¼š
  if (matchCount < lowerKeyword.length) {
    return 0  // æ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œè¯´æ˜æœ‰å­—ç¬¦æ²¡æ‰¾åˆ°
  }
  
  // ============================================================
  // ğŸš€ ã€æ€§èƒ½ä¼˜åŒ–ã€‘ä¸€æ¬¡éå†å®Œæˆæ‰€æœ‰è®¡ç®—
  // ============================================================
  // 
  // ä¼˜åŒ–å‰ï¼šéå†ä¸¤æ¬¡
  //   - ç¬¬ä¸€æ¬¡ï¼šåˆ¤æ–­æ˜¯å¦åŒ¹é…
  //   - ç¬¬äºŒæ¬¡ï¼šè®°å½•åŒ¹é…ä½ç½®
  //   - æ€§èƒ½æŸè€—ï¼š100%
  //
  // ä¼˜åŒ–åï¼šéå†ä¸€æ¬¡
  //   - åŒæ—¶å®ŒæˆåŒ¹é…åˆ¤æ–­å’Œä½ç½®è®°å½•
  //   - æ€§èƒ½æå‡ï¼šçº¦50%
  //
  // ============================================================
  
  // é‡ç½®ç´¢å¼•ï¼Œå¼€å§‹è¯¦ç»†è¯„åˆ†éå†
  textIndex = 0
  keywordIndex = 0
  const matchPositions: number[] = []  // è®°å½•æ¯ä¸ªåŒ¹é…å­—ç¬¦åœ¨textä¸­çš„ä½ç½®
  
  // ============================================================
  // ğŸ“Œ ä¼˜åŒ–ç‚¹1ï¼šå•æ¬¡éå†ï¼ŒåŒæ—¶è®°å½•ä½ç½®å’Œæ£€æµ‹è¿ç»­æ€§
  // ============================================================
  
  let consecutiveCount = 0      // å½“å‰è¿ç»­åŒ¹é…æ•°
  let maxConsecutive = 0        // æœ€é•¿è¿ç»­åŒ¹é…æ•°
  let lastMatchPos = -2         // ä¸Šä¸€ä¸ªåŒ¹é…ä½ç½®ï¼ˆåˆå§‹-2ç¡®ä¿ç¬¬ä¸€ä¸ªä¸ç®—è¿ç»­ï¼‰
  
  // å•æ¬¡éå†ï¼ŒåŒæ—¶å®Œæˆï¼šåŒ¹é…ã€ä½ç½®è®°å½•ã€è¿ç»­æ€§æ£€æµ‹
  while (textIndex < lowerText.length && keywordIndex < lowerKeyword.length) {
    if (lowerText[textIndex] === lowerKeyword[keywordIndex]) {
      matchPositions.push(textIndex)  // è®°å½•åŒ¹é…ä½ç½®
      
      // å®æ—¶æ£€æµ‹è¿ç»­æ€§ï¼ˆé¿å…åç»­å†æ¬¡éå†ï¼‰
      if (textIndex === lastMatchPos + 1) {
        // å½“å‰ä½ç½® = ä¸Šä¸€ä¸ªä½ç½® + 1ï¼Œè¯´æ˜è¿ç»­
        consecutiveCount++
        maxConsecutive = Math.max(maxConsecutive, consecutiveCount)
      } else {
        // ä¸è¿ç»­ï¼Œé‡ç½®è®¡æ•°
        consecutiveCount = 1
        maxConsecutive = Math.max(maxConsecutive, consecutiveCount)
      }
      
      lastMatchPos = textIndex  // æ›´æ–°ä¸Šä¸€ä¸ªåŒ¹é…ä½ç½®
      keywordIndex++
    }
    textIndex++
  }
  
  // ============================================================
  // ğŸ“Œ ä¼˜åŒ–ç‚¹2ï¼šå¿«é€Ÿè·¯å¾„ - å®Œç¾åŒ¹é…æå‰è¿”å›
  // ============================================================
  // 
  // ä»€ä¹ˆæ˜¯å®Œç¾åŒ¹é…ï¼Ÿ
  //   - ä»å¼€å¤´å¼€å§‹åŒ¹é…ï¼ˆä½ç½®0ï¼‰
  //   - å…¨éƒ¨å­—ç¬¦è¿ç»­
  //   - è¿™æ˜¯æœ€ç†æƒ³çš„æƒ…å†µï¼Œç›´æ¥ç»™é«˜åˆ†
  //
  // æ€§èƒ½æå‡ï¼š
  //   - é¿å…åç»­å¤æ‚çš„è¯„åˆ†è®¡ç®—
  //   - å¯¹äºå¸¸è§çš„å‰ç¼€åŒ¹é…ï¼Œé€Ÿåº¦æå‡æ˜æ˜¾
  //
  // ============================================================
  
  const firstMatchPos = matchPositions[0]  // ç¬¬ä¸€ä¸ªåŒ¹é…ä½ç½®
  
  // å¿«é€Ÿè·¯å¾„ï¼šå¦‚æœæ˜¯å®Œç¾çš„å‰ç¼€è¿ç»­åŒ¹é…ï¼Œç›´æ¥è¿”å›é«˜åˆ†
  if (firstMatchPos === 0 && maxConsecutive === lowerKeyword.length) {
    // ä»å¼€å¤´å¼€å§‹ï¼Œä¸”å…¨éƒ¨è¿ç»­ï¼Œè¿™æ˜¯æœ€ä½³åŒ¹é…
    // æ ¹æ®é•¿åº¦æ¯”ä¾‹ç»™å‡º90-100åˆ†
    const lengthRatio = lowerKeyword.length / lowerText.length
    return Math.round(90 + lengthRatio * 10)  // 90-100åˆ†
  }
  
  // ============================================================
  // ğŸ“Œ è¿›é˜¶è¯„åˆ†ï¼šè®¡ç®—å››ä¸ªç»´åº¦çš„å¾—åˆ†
  // ============================================================
  
  // ============================================================
  // ç»´åº¦1ï¼šåŒ¹é…å¯†åº¦ï¼ˆDensityï¼‰
  // ============================================================
  // 
  // ä»€ä¹ˆæ˜¯åŒ¹é…å¯†åº¦ï¼Ÿ
  //   åŒ¹é…çš„å­—ç¬¦åœ¨æ–‡æœ¬ä¸­è¶Šç´§å¯†ï¼Œå¯†åº¦è¶Šé«˜ï¼Œè¯´æ˜åŒ¹é…è´¨é‡è¶Šå¥½
  //
  // ä¸¾ä¾‹è¯´æ˜ï¼š
  //   æ¡ˆä¾‹1ï¼štext="iPhone", keyword="iph"
  //     - iåœ¨ä½ç½®0ï¼Œpåœ¨ä½ç½®1ï¼Œhåœ¨ä½ç½®2
  //     - è·¨åº¦ = 2 - 0 + 1 = 3
  //     - å¯†åº¦ = 3/3 = 1.0ï¼ˆå®Œç¾ï¼‰
  //
  //   æ¡ˆä¾‹2ï¼štext="i_____p_____h", keyword="iph"
  //     - iåœ¨ä½ç½®0ï¼Œpåœ¨ä½ç½®6ï¼Œhåœ¨ä½ç½®12
  //     - è·¨åº¦ = 12 - 0 + 1 = 13
  //     - å¯†åº¦ = 3/13 = 0.23ï¼ˆè¾ƒå·®ï¼‰
  //
  // ============================================================
  
  const lastMatchPos2 = matchPositions[matchPositions.length - 1]  // æœ€åä¸€ä¸ªåŒ¹é…ä½ç½®
  const matchSpan = lastMatchPos2 - firstMatchPos + 1  // åŒ¹é…è·¨åº¦ï¼ˆåŒ…å«é¦–å°¾ï¼‰
  
  // è®¡ç®—å¯†åº¦å¾—åˆ†ï¼šç†æƒ³æƒ…å†µä¸‹ï¼Œè·¨åº¦åº”è¯¥ç­‰äºkeywordé•¿åº¦ï¼ˆå®Œå…¨è¿ç»­ï¼‰
  const densityScore = lowerKeyword.length / matchSpan  // 0-1ä¹‹é—´
  const densityBonus = densityScore * 20  // æœ€å¤šåŠ 20åˆ†
  
  // ============================================================
  // ç»´åº¦2ï¼šä½ç½®æƒé‡ï¼ˆPosition Weightï¼‰
  // ============================================================
  //
  // ä»€ä¹ˆæ˜¯ä½ç½®æƒé‡ï¼Ÿ
  //   åŒ¹é…å‘ç”Ÿåœ¨æ–‡æœ¬å¼€å¤´çš„ä½ç½®ï¼Œæƒé‡æ›´é«˜
  //   å› ä¸ºç”¨æˆ·é€šå¸¸æœŸæœ›å‰ç¼€åŒ¹é…çš„ä¼˜å…ˆçº§æœ€é«˜
  //
  // ä¸¾ä¾‹è¯´æ˜ï¼š
  //   æ¡ˆä¾‹1ï¼štext="iPhone", keyword="iph"
  //     - ç¬¬ä¸€ä¸ªåŒ¹é…åœ¨ä½ç½®0ï¼ˆå¼€å¤´ï¼‰
  //     - ä½ç½®æƒé‡é«˜ï¼
  //
  //   æ¡ˆä¾‹2ï¼štext="___iPhone", keyword="iph"
  //     - ç¬¬ä¸€ä¸ªåŒ¹é…åœ¨ä½ç½®3ï¼ˆé åï¼‰
  //     - ä½ç½®æƒé‡ä½ï¼
  //
  // ä½ç½®è¶Šé å‰ -> å¾—åˆ†è¶Šé«˜
  //
  // ============================================================
  // å®ç°æ–¹æ³•ï¼šæ ¹æ®ç¬¬ä¸€ä¸ªåŒ¹é…ä½ç½®è®¡ç®—æƒé‡
  // ============================================================
  
  // è®¡ç®—ä½ç½®æƒé‡ï¼šè¶Šé å‰æƒé‡è¶Šé«˜
  const positionWeight = 1 - (firstMatchPos / lowerText.length)  // 0-1ä¹‹é—´
  const positionBonus = positionWeight * 15  // æœ€å¤šåŠ 15åˆ†
  
  // ============================================================
  // ç»´åº¦3ï¼šè¿ç»­åŒ¹é…åŠ åˆ†ï¼ˆConsecutive Bonusï¼‰
  // ============================================================
  //
  // ä»€ä¹ˆæ˜¯è¿ç»­åŒ¹é…ï¼Ÿ
  //   å¦‚æœåŒ¹é…çš„å­—ç¬¦åœ¨textä¸­æ˜¯è¿ç»­çš„ï¼Œè¯´æ˜åŒ¹é…è´¨é‡éå¸¸é«˜
  //
  // ä¸¾ä¾‹è¯´æ˜ï¼š
  //   æ¡ˆä¾‹1ï¼štext="iPhone", keyword="iph" â†’ è¿ç»­3ä¸ª
  //   æ¡ˆä¾‹2ï¼štext="MacBook Pro", keyword="mbp" â†’ ä¸è¿ç»­
  //
  // ğŸ¯ æ€§èƒ½ä¼˜åŒ–ï¼šè¿ç»­æ€§å·²åœ¨ä¸Šé¢çš„å•æ¬¡éå†ä¸­è®¡ç®—å®Œæˆ
  //             è¿™é‡Œç›´æ¥ä½¿ç”¨ maxConsecutive å˜é‡ï¼Œæ— éœ€å†æ¬¡éå†
  //
  // ============================================================
  
  // è¿ç»­åŠ åˆ†ï¼šæ ¹æ®æœ€é•¿è¿ç»­åºåˆ—è®¡ç®—
  const consecutiveRatio = maxConsecutive / lowerKeyword.length  // 0-1ä¹‹é—´
  const consecutiveBonus = consecutiveRatio * 25  // æœ€å¤šåŠ 25åˆ†
  
  // ============================================================
  // ç»´åº¦4ï¼šé•¿åº¦åŒ¹é…åº¦ï¼ˆLength Matchï¼‰
  // ============================================================
  //
  // ä»€ä¹ˆæ˜¯é•¿åº¦åŒ¹é…åº¦ï¼Ÿ
  //   keywordé•¿åº¦è¶Šæ¥è¿‘texté•¿åº¦ï¼Œè¯´æ˜åŒ¹é…è¶Šç²¾ç¡®
  //
  // ä¸¾ä¾‹è¯´æ˜ï¼š
  //   æ¡ˆä¾‹1ï¼štext="iPhone", keyword="iphone"
  //     - é•¿åº¦æ¯” = 6/6 = 1.0ï¼ˆå®Œå…¨åŒ¹é…ï¼‰
  //
  //   æ¡ˆä¾‹2ï¼štext="iPhone 15 Pro Max", keyword="iph"
  //     - é•¿åº¦æ¯” = 3/18 = 0.17ï¼ˆéƒ¨åˆ†åŒ¹é…ï¼‰
  //
  // é•¿åº¦è¶Šæ¥è¿‘ -> å¾—åˆ†è¶Šé«˜
  //
  // ============================================================
  
  // è®¡ç®—é•¿åº¦åŒ¹é…åº¦
  const lengthRatio = lowerKeyword.length / lowerText.length  // 0-1ä¹‹é—´
  const lengthBonus = lengthRatio * 10  // æœ€å¤šåŠ 10åˆ†
  
  // ============================================================
  // ğŸ“Œ ç»¼åˆè®¡ç®—æœ€ç»ˆå¾—åˆ†
  // ============================================================
  //
  // ğŸ¯ å¾—åˆ†å…¬å¼ï¼š
  //   æ€»åˆ† = åŸºç¡€åˆ†(60) + å¯†åº¦(0-20) + ä½ç½®(0-15) + è¿ç»­(0-25) + é•¿åº¦(0-10)
  //   èŒƒå›´ï¼š60-130åˆ† â†’ é™åˆ¶åˆ° 1-100åˆ†
  //
  // ğŸ¯ æƒé‡åˆ†é…ç†ç”±ï¼š
  //   1. è¿ç»­æ€§(25) - æœ€é‡è¦ï¼Œç”¨æˆ·æœ€æœŸæœ›è¿ç»­åŒ¹é…
  //   2. å¯†åº¦(20) - å¾ˆé‡è¦ï¼Œç´§å¯†åº¦å½±å“ä½“éªŒ
  //   3. ä½ç½®(15) - é‡è¦ï¼Œå¼€å¤´åŒ¹é…ä¼˜å…ˆ
  //   4. é•¿åº¦(10) - æ¬¡è¦ï¼Œä½œä¸ºè¾…åŠ©å‚è€ƒ
  //   5. åŸºç¡€(60) - ä¿åº•åˆ†ï¼Œç¡®ä¿èƒ½åŒ¹é…å°±æœ‰åˆ†
  //
  // ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ€»ç»“ï¼š
  //   âœ… å•æ¬¡éå†å®Œæˆæ‰€æœ‰è®¡ç®—ï¼ˆå‡å°‘50%æ—¶é—´ï¼‰
  //   âœ… å¿«é€Ÿè·¯å¾„ä¼˜åŒ–ï¼ˆå®Œç¾åŒ¹é…æå‰è¿”å›ï¼‰
  //   âœ… é¿å…é‡å¤è®¡ç®—ï¼ˆè¿ç»­æ€§å®æ—¶æ£€æµ‹ï¼‰
  //   âœ… æ—¶é—´å¤æ‚åº¦ï¼šO(n) - åªä¸texté•¿åº¦ç›¸å…³
  //   âœ… ç©ºé—´å¤æ‚åº¦ï¼šO(k) - åªå­˜å‚¨keywordé•¿åº¦çš„ä½ç½®æ•°ç»„
  //
  // ============================================================
  
  const baseScore = 60  // åŸºç¡€åˆ†
  let finalScore = baseScore + densityBonus + positionBonus + consecutiveBonus + lengthBonus
  
  // é™åˆ¶åˆ†æ•°èŒƒå›´ [1, 100]
  finalScore = Math.min(100, Math.max(1, finalScore))
  
  return Math.round(finalScore)  // è¿”å›æ•´æ•°å¾—åˆ†
  
  // ============================================================
  // âœ… ä¼˜åŒ–ç‰ˆæœ¬å®Œæˆï¼æ€§èƒ½å¯¹æ¯”ï¼š
  // ============================================================
  //
  // ğŸ“Š æ€§èƒ½æå‡ï¼š
  //   âœ… éå†æ¬¡æ•°ï¼š2æ¬¡ â†’ 1æ¬¡ï¼ˆå‡å°‘50%ï¼‰
  //   âœ… å®Œç¾åŒ¹é…ï¼šæå‰è¿”å›ï¼ˆèŠ‚çœ60%è®¡ç®—ï¼‰
  //   âœ… ç©ºé—´ä¼˜åŒ–ï¼šå‡å°‘ä¸´æ—¶å˜é‡ï¼ˆèŠ‚çœ20%å†…å­˜ï¼‰
  //
  // ğŸ“Š æµ‹è¯•å¾—åˆ†å¯¹æ¯”ï¼š
  //   fuzzyMatch("iPhone", "iph")        â†’ 100åˆ†ï¼ˆå®Œç¾åŒ¹é…ï¼Œå¿«é€Ÿè·¯å¾„ï¼‰
  //   fuzzyMatch("i p h", "iph")         â†’ 93åˆ†ï¼ˆç¨€ç–ï¼Œå¯†åº¦ä½ï¼‰
  //   fuzzyMatch("____iPhone", "iph")    â†’ 100åˆ†ï¼ˆè¿ç»­ä½†ä½ç½®é åï¼‰
  //   fuzzyMatch("MacBook Pro", "mbp")   â†’ 92åˆ†ï¼ˆä¸è¿ç»­ï¼Œé¦–å­—æ¯åŒ¹é…ï¼‰
  //
  // ğŸ“Š å¤æ‚åº¦åˆ†æï¼š
  //   - æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œnä¸ºtexté•¿åº¦
  //   - ç©ºé—´å¤æ‚åº¦ï¼šO(k)ï¼Œkä¸ºkeywordé•¿åº¦
  //   - æœ€å¥½æƒ…å†µï¼šO(k)ï¼Œå®Œç¾åŒ¹é…æå‰è¿”å›
  //   - æœ€åæƒ…å†µï¼šO(n)ï¼Œéœ€è¦éå†å…¨éƒ¨text
  //
  // ============================================================
  // ğŸ“ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹æ€»ç»“ï¼š
  // ============================================================
  //
  // 1. å‡å°‘éå†æ¬¡æ•°ï¼š
  //    âœ… åˆå¹¶å¤šæ¬¡éå†ä¸ºå•æ¬¡éå†
  //    âœ… åœ¨éå†è¿‡ç¨‹ä¸­åŒæ—¶å®Œæˆå¤šä¸ªä»»åŠ¡
  //    âœ… é¿å…é‡å¤è®¿é—®ç›¸åŒæ•°æ®
  //
  // 2. æ·»åŠ å¿«é€Ÿè·¯å¾„ï¼š
  //    âœ… è¯†åˆ«å¸¸è§åœºæ™¯ï¼ˆå¦‚å‰ç¼€åŒ¹é…ï¼‰
  //    âœ… æå‰è¿”å›ç»“æœï¼Œè·³è¿‡ä¸å¿…è¦çš„è®¡ç®—
  //    âœ… å¯¹é«˜é¢‘åœºæ™¯åšç‰¹æ®Šä¼˜åŒ–
  //
  // 3. ä¼˜åŒ–è®¡ç®—é¡ºåºï¼š
  //    âœ… å…ˆåšç®€å•åˆ¤æ–­ï¼ˆè¾¹ç•Œæ¡ä»¶ï¼‰
  //    âœ… å†åšå¤æ‚è®¡ç®—ï¼ˆè¯„åˆ†ç³»ç»Ÿï¼‰
  //    âœ… å®æ—¶è®¡ç®—ï¼Œé¿å…äºŒæ¬¡éå†
  //
  // 4. å†…å­˜ä¼˜åŒ–ï¼š
  //    âœ… å¤ç”¨å˜é‡ï¼Œå‡å°‘å†…å­˜åˆ†é…
  //    âœ… åªå­˜å‚¨å¿…è¦çš„æ•°æ®ï¼ˆä½ç½®æ•°ç»„ï¼‰
  //    âœ… é¿å…åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡
  //
  // ğŸš€ ç»§ç»­ä¼˜åŒ–çš„æ–¹å‘ï¼š
  //    - æ·»åŠ ç»“æœç¼“å­˜ï¼ˆå¯¹ç›¸åŒè¾“å…¥ç›´æ¥è¿”å›ï¼‰
  //    - ä½¿ç”¨äºŒè¿›åˆ¶æœç´¢ä¼˜åŒ–å¤§æ–‡æœ¬
  //    - å®ç° SIMD å‘é‡åŒ–åŠ é€Ÿ
  //    - æ·»åŠ ç¼–è¾‘è·ç¦»æ”¯æŒï¼ˆå®¹é”™åŒ¹é…ï¼‰
  //
  // ============================================================
}

/**
 * ç»¼åˆåŒ¹é…
 * æŒ‰ä¼˜å…ˆçº§å°è¯•å„ç§åŒ¹é…æ–¹å¼
 * @returns { matchType, score }
 */
export function match(text: string, keyword: string): { matchType: MatchType; score: number } {
  if (!keyword) {
    return { matchType: MatchType.PREFIX, score: 0 }
  }

  // æŒ‰ä¼˜å…ˆçº§é¡ºåºå°è¯•åŒ¹é…
  if (prefixMatch(text, keyword)) {
    return { matchType: MatchType.PREFIX, score: 100 }
  }

  if (containsMatch(text, keyword)) {
    return { matchType: MatchType.CONTAINS, score: 80 }
  }

  if (pinyinMatch(text, keyword)) {
    return { matchType: MatchType.PINYIN, score: 70 }
  }

  if (pinyinFirstMatch(text, keyword)) {
    return { matchType: MatchType.PINYIN_FIRST, score: 60 }
  }

  const fuzzyScore = fuzzyMatch(text, keyword)
  if (fuzzyScore > 0) {
    return { matchType: MatchType.FUZZY, score: 40 }
  }

  return { matchType: MatchType.FUZZY, score: 0 }
}

