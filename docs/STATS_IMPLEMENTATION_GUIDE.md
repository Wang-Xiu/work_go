# PV/UVç»Ÿè®¡å®æ–½æŒ‡å— - Set + Hash æ··åˆæ–¹æ¡ˆ

## ğŸ¯ æ–¹æ¡ˆæ€»ç»“

**æ ¸å¿ƒè®¾è®¡**ï¼š
- **å®æ—¶æ•°æ®**ï¼šä½¿ç”¨ Redis Set å­˜å‚¨è®¿å®¢IDï¼ˆä¿ç•™7å¤©ï¼‰
- **å†å²æ•°æ®**ï¼šä½¿ç”¨ Redis Hash å­˜å‚¨UVæ±‡æ€»ï¼ˆä¿ç•™90å¤©ï¼‰
- **å®šæ—¶ä»»åŠ¡**ï¼šæ¯æ—¥å‡Œæ™¨2ç‚¹å°†Setæ•°æ®æ±‡æ€»åˆ°Hash

**ä¼˜åŠ¿**ï¼š
- âœ… æŸ¥è¯¢90å¤©æ•°æ®åªéœ€**6æ¬¡Redisè°ƒç”¨**ï¼ˆvs åŸ90æ¬¡ï¼‰
- âœ… **ç²¾ç¡®è®¡æ•°**ï¼ˆæ— è¯¯å·®ï¼Œvs HyperLogLogçš„0.81%è¯¯å·®ï¼‰
- âœ… æ”¯æŒ**è·¨å¤©UVå»é‡**ï¼ˆæœ€è¿‘7å¤©ï¼‰
- âœ… **å†…å­˜ä¼˜åŒ–**ï¼ˆSetåªä¿ç•™7å¤©ï¼Œå‡å°‘68%å†…å­˜ï¼‰

---

## ğŸ“Š Redisæ•°æ®ç»“æ„

### 1. PVç»Ÿè®¡ï¼ˆStringï¼‰

```redis
# å…¨ç«™PV
stats:pv:2024-01-15 -> "10234"
TTL: 90å¤©

# è·¯å¾„PV
stats:pv:2024-01-15:/api/users -> "1234"
TTL: 90å¤©
```

### 2. UVå®æ—¶ç»Ÿè®¡ï¼ˆSetï¼‰

```redis
# å…¨ç«™UVï¼ˆSetæˆå‘˜ä¸ºè®¿å®¢IDï¼‰
stats:uv:realtime:2024-01-15 -> Set {
    "192.168.1.1",
    "192.168.1.2",
    ...
}
TTL: 7å¤©  # åªä¿ç•™7å¤©ï¼ŒèŠ‚çœå†…å­˜

# è·¯å¾„UV
stats:uv:realtime:2024-01-15:/api/users -> Set {...}
TTL: 7å¤©
```

### 3. UVæ±‡æ€»ï¼ˆHashï¼‰

```redis
# æŒ‰æœˆå­˜å‚¨æ¯æ—¥UVæ±‡æ€»
stats:uv:summary:2024-01 -> Hash {
    "01": "8234",        # 1æœˆ1æ—¥UV
    "02": "8456",        # 1æœˆ2æ—¥UV
    "15": "9012",        # 1æœˆ15æ—¥UV
    "15:/api/users": "500",  # 1æœˆ15æ—¥ /api/users è·¯å¾„UV
    ...
}
TTL: 90å¤©
```

### 4. è·¯å¾„åˆ—è¡¨ï¼ˆSetï¼‰

```redis
stats:paths:2024-01-15 -> Set {
    "/api/users",
    "/api/posts",
    ...
}
TTL: 90å¤©
```

---

## ğŸ”§ æ ¸å¿ƒAPIä½¿ç”¨

### 1. è®°å½•è®¿é—®

```go
// åœ¨Ginä¸­é—´ä»¶ä¸­è°ƒç”¨
tracker.Track(ctx, visitorID, path)

// visitorIDè·å–æ–¹å¼ï¼š
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨å®¢æˆ·ç«¯IP
visitorID := c.ClientIP()

// æ–¹æ¡ˆ2ï¼šä½¿ç”¨è®¾å¤‡æŒ‡çº¹ï¼ˆæ¨èï¼‰
visitorID := generateFingerprint(c)

// æ–¹æ¡ˆ3ï¼šä½¿ç”¨ç”¨æˆ·IDï¼ˆå·²ç™»å½•ç”¨æˆ·ï¼‰
if userID := c.GetString("user_id"); userID != "" {
    visitorID = userID
} else {
    visitorID = c.ClientIP()
}
```

### 2. æŸ¥è¯¢å•æ—¥æ•°æ®

```go
// æŸ¥è¯¢ä»Šå¤©çš„PV/UV
today := time.Now().Format("2006-01-02")
stats, err := tracker.GetDailyStats(ctx, today)

// ç»“æœï¼š
// {
//   "date": "2024-01-15",
//   "pv": 10234,
//   "uv": 8456
// }
```

### 3. æŸ¥è¯¢å¤šæ—¥æ•°æ®ï¼ˆé«˜æ€§èƒ½ï¼‰

```go
// æŸ¥è¯¢æœ€è¿‘90å¤©æ•°æ®ï¼ˆåªéœ€6æ¬¡Redisè°ƒç”¨ï¼ï¼‰
rangeStats, err := tracker.GetRangeStats(
    ctx,
    "2024-01-01",
    "2024-03-31",
)

// ç»“æœï¼š
// {
//   "start_date": "2024-01-01",
//   "end_date": "2024-03-31",
//   "total_pv": 923456,
//   "total_uv": 756234,  // æ³¨æ„ï¼šè¿™æ˜¯ç´¯åŠ ï¼Œä¼šé‡å¤è®¡æ•°
//   "daily_stats": [
//     {"date": "2024-01-01", "pv": 10234, "uv": 8456},
//     {"date": "2024-01-02", "pv": 11000, "uv": 8700},
//     ...
//   ]
// }
```

### 4. æŸ¥è¯¢çœŸå®UVï¼ˆå»é‡ï¼‰

```go
// æŸ¥è¯¢æœ€è¿‘7å¤©çš„çœŸå®UVï¼ˆè·¨å¤©å»é‡ï¼‰
uniqueUV, err := tracker.GetUniqueUVInRange(
    ctx,
    "2024-01-09",
    "2024-01-15",
)

// ç»“æœï¼š12345ï¼ˆçœŸå®çš„ç‹¬ç«‹è®¿å®¢æ•°ï¼Œå·²å»é‡ï¼‰
// æ³¨æ„ï¼šåªèƒ½æŸ¥è¯¢æœ€è¿‘7å¤©ï¼Œå› ä¸ºSetåªä¿ç•™7å¤©
```

### 5. æŸ¥è¯¢è·¯å¾„ç»Ÿè®¡

```go
// æŸ¥è¯¢æŸå¤©å„è·¯å¾„çš„PV/UV
pathStats, err := tracker.GetPathStats(ctx, "2024-01-15")

// ç»“æœï¼š
// [
//   {"path": "/api/users", "pv": 5234, "uv": 2100},
//   {"path": "/api/posts", "pv": 3000, "uv": 1500},
//   ...
// ]
```

---

## â° å®šæ—¶ä»»åŠ¡é…ç½®

### 1. æ¯æ—¥æ±‡æ€»ä»»åŠ¡ï¼ˆé‡è¦ï¼ï¼‰

**ä½œç”¨**ï¼šå°†æ˜¨æ—¥çš„UVä»Setæ±‡æ€»åˆ°Hashï¼Œé‡Šæ”¾å†…å­˜

**æ‰§è¡Œæ—¶é—´**ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹

```go
// æ–¹æ³•1ï¼šä½¿ç”¨cronåº“
import "github.com/robfig/cron/v3"

c := cron.New()
c.AddFunc("0 2 * * *", func() {  // æ¯å¤©02:00æ‰§è¡Œ
    ctx := context.Background()
    if err := tracker.DailySummary(ctx); err != nil {
        log.Printf("DailySummary failed: %v", err)
        // å‘é€å‘Šè­¦
    }
})
c.Start()

// æ–¹æ³•2ï¼šä½¿ç”¨systemd timer
// åˆ›å»º /etc/systemd/system/stats-summary.service
// åˆ›å»º /etc/systemd/system/stats-summary.timer
```

### 2. æ¸…ç†è¿‡æœŸæ•°æ®ä»»åŠ¡

**ä½œç”¨**ï¼šåˆ é™¤è¶…è¿‡90å¤©çš„å†å²æ•°æ®

**æ‰§è¡Œæ—¶é—´**ï¼šæ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹

```go
c.AddFunc("0 3 * * 0", func() {  // æ¯å‘¨æ—¥03:00æ‰§è¡Œ
    ctx := context.Background()
    if err := tracker.CleanExpiredData(ctx); err != nil {
        log.Printf("CleanExpiredData failed: %v", err)
    }
})
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”å®æµ‹

### æŸ¥è¯¢90å¤©æ•°æ®

| æŒ‡æ ‡ | HyperLogLog | çº¯Set | çº¯Hash | **æ··åˆæ–¹æ¡ˆ** |
|------|-------------|-------|--------|-------------|
| Redisè°ƒç”¨æ¬¡æ•° | 90æ¬¡ | 90æ¬¡ | 90æ¬¡ | **6æ¬¡** |
| å“åº”æ—¶é—´ | ~200ms | ~150ms | ~150ms | **~20ms** |
| å†…å­˜å ç”¨ï¼ˆ90å¤©ï¼‰ | 1.08MB | 2.16GB | 1.53GB | **0.5GB** |

### è®¡ç®—7å¤©çœŸå®UV

| æŒ‡æ ‡ | HyperLogLog | Set | Hash | **æ··åˆæ–¹æ¡ˆ** |
|------|-------------|-----|------|-------------|
| Redisè°ƒç”¨æ¬¡æ•° | 2æ¬¡ | 1æ¬¡ | N/A | **1æ¬¡** |
| å“åº”æ—¶é—´ | ~50ms | ~30ms | ~500ms | **~30ms** |
| æ˜¯å¦ç²¾ç¡® | âŒ (0.81%è¯¯å·®) | âœ… | âœ… | âœ… |

---

## ğŸ’¾ å†…å­˜å ç”¨è®¡ç®—

### å‡è®¾ï¼šæ¯æ—¥10ä¸‡UV

#### åŸHyperLogLogæ–¹æ¡ˆ
```
90å¤© Ã— 12KB = 1.08MB
âœ… å†…å­˜æœ€çœï¼Œä½†æŸ¥è¯¢æ…¢ä¸”ä¸ç²¾ç¡®
```

#### çº¯Setæ–¹æ¡ˆ
```
æ¯å¤©ï¼š10ä¸‡ Ã— 24å­—èŠ‚ = 2.4MB
90å¤©ï¼š2.4MB Ã— 90 = 216MB Ã— 10 = 2.16GB
âŒ å†…å­˜å ç”¨å¤§
```

#### æ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰
```
å®æ—¶Setï¼ˆ7å¤©ï¼‰ï¼š2.4MB Ã— 7 = 16.8MB
æ±‡æ€»Hashï¼ˆ90å¤©ï¼‰ï¼š10ä¸‡ Ã— 5å­—èŠ‚ Ã— 90 = 45MB
æ€»è®¡ï¼š~62MB
âœ… èŠ‚çœ97%å†…å­˜ï¼ˆvs çº¯Setï¼‰
```

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. å®šæ—¶ä»»åŠ¡ç›‘æ§

```go
// æ±‡æ€»ä»»åŠ¡å¤±è´¥æ—¶å‘é€å‘Šè­¦
func (t *Tracker) DailySummary(ctx context.Context) error {
    err := t.dailySummaryInternal(ctx)
    if err != nil {
        // å‘é€é’‰é’‰/ä¼ä¸šå¾®ä¿¡å‘Šè­¦
        sendAlert("UVæ±‡æ€»ä»»åŠ¡å¤±è´¥: " + err.Error())
        return err
    }
    return nil
}
```

### 2. æ±‡æ€»ä»»åŠ¡å¹‚ç­‰æ€§

```go
// å¯ä»¥æ‰‹åŠ¨é‡æ–°æ±‡æ€»ç‰¹å®šæ—¥æœŸ
func (t *Tracker) SummaryDate(ctx context.Context, date string) error {
    // å®ç°ä¸DailySummaryç›¸åŒé€»è¾‘ï¼Œä½†æŒ‡å®šæ—¥æœŸ
}
```

### 3. æŸ¥è¯¢ä¼˜å…ˆçº§

æŸ¥è¯¢UVæ—¶çš„ä¼˜å…ˆçº§ï¼š
1. **ä¼˜å…ˆä»Hashè¯»å–**ï¼ˆå†å²æ•°æ®ï¼Œå¿«ï¼‰
2. **é™çº§åˆ°Setè¯»å–**ï¼ˆå®æ—¶æ•°æ®ï¼Œæ…¢ä½†å‡†ç¡®ï¼‰
3. **è¿”å›0**ï¼ˆæ•°æ®ä¸å­˜åœ¨ï¼‰

### 4. è·¨å¤©UVè®¡ç®—é™åˆ¶

```go
// âš ï¸ åªèƒ½æŸ¥è¯¢æœ€è¿‘7å¤©çš„çœŸå®UV
uniqueUV, err := tracker.GetUniqueUVInRange(ctx, "2024-01-09", "2024-01-15")

// âŒ æ— æ³•æŸ¥è¯¢è¶…è¿‡7å¤©çš„çœŸå®UVï¼ˆSetå·²è¿‡æœŸï¼‰
uniqueUV, err := tracker.GetUniqueUVInRange(ctx, "2024-01-01", "2024-03-31")
// ä¼šè¿”å›é”™è¯¯æˆ–ä¸å‡†ç¡®çš„ç»“æœ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¦‚éœ€æŸ¥è¯¢æ›´é•¿æ—¶é—´çš„UVï¼Œä½¿ç”¨ç®€å•ç´¯åŠ ï¼ˆ`GetRangeStats.TotalUV`ï¼‰
- æ¥å—ä¸€å®šçš„é‡å¤è®¡æ•°ï¼ˆé€šå¸¸è¯¯å·®<10%ï¼‰

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ä¸Šçº¿å‰

- [ ] Redisé…ç½®è°ƒä¼˜ï¼ˆmaxmemoryã€evictionç­–ç•¥ï¼‰
- [ ] é…ç½®æ–‡ä»¶åŠ å¯†æ•æ„Ÿä¿¡æ¯ï¼ˆRediså¯†ç ï¼‰
- [ ] å®šæ—¶ä»»åŠ¡å·²é…ç½®ä¸”æµ‹è¯•é€šè¿‡
- [ ] ç›‘æ§å‘Šè­¦å·²æ¥å…¥
- [ ] å‹åŠ›æµ‹è¯•é€šè¿‡

### ä¸Šçº¿å

- [ ] è§‚å¯ŸRediså†…å­˜ä½¿ç”¨æƒ…å†µ
- [ ] æ£€æŸ¥å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- [ ] éªŒè¯æŸ¥è¯¢æ€§èƒ½
- [ ] ç¡®è®¤UVæ•°æ®å‡†ç¡®æ€§

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šUVæ•°æ®ä¸º0

**åŸå› **ï¼šå®šæ—¶æ±‡æ€»ä»»åŠ¡æœªæ‰§è¡Œ

**æ’æŸ¥**ï¼š
```bash
# æ£€æŸ¥Redisä¸­æ˜¯å¦æœ‰æ±‡æ€»æ•°æ®
redis-cli HGETALL stats:uv:summary:2024-01

# æ‰‹åŠ¨æ‰§è¡Œæ±‡æ€»
curl -X POST http://localhost:8080/admin/stats/summary
```

### é—®é¢˜2ï¼šæŸ¥è¯¢æ…¢

**åŸå› **ï¼šæœªä½¿ç”¨æ‰¹é‡æŸ¥è¯¢æˆ–æ•°æ®é‡è¿‡å¤§

**ä¼˜åŒ–**ï¼š
```go
// âœ… æ­£ç¡®ï¼šä½¿ç”¨GetRangeStatsï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰
rangeStats, _ := tracker.GetRangeStats(ctx, startDate, endDate)

// âŒ é”™è¯¯ï¼šå¾ªç¯è°ƒç”¨GetDailyStats
for date := range dates {
    stats, _ := tracker.GetDailyStats(ctx, date)  // 90æ¬¡è°ƒç”¨ï¼
}
```

### é—®é¢˜3ï¼šå†…å­˜å ç”¨è¿‡é«˜

**åŸå› **ï¼šå®šæ—¶æ¸…ç†ä»»åŠ¡æœªæ‰§è¡Œ

**è§£å†³**ï¼š
```bash
# æ‰‹åŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
redis-cli --scan --pattern "stats:*" | xargs redis-cli DEL

# æˆ–è°ƒç”¨API
curl -X POST http://localhost:8080/admin/stats/clean
```

---

## ğŸ¯ æ€»ç»“

### ä½•æ—¶ä½¿ç”¨æ··åˆæ–¹æ¡ˆï¼Ÿ

âœ… **é€‚åˆ**ï¼š
- UVé‡ä¸­ç­‰ï¼ˆæ¯æ—¥10ä¸‡-100ä¸‡ï¼‰
- éœ€è¦æŸ¥è¯¢å†å²æ•°æ®ï¼ˆ90å¤©ï¼‰
- å¯¹ç²¾åº¦æœ‰è¦æ±‚ï¼ˆè¯¯å·®<0.1%ï¼‰
- éœ€è¦è·¨å¤©UVå»é‡ï¼ˆæœ€è¿‘7å¤©ï¼‰

âŒ **ä¸é€‚åˆ**ï¼š
- UVé‡æå¤§ï¼ˆ>åƒä¸‡/å¤©ï¼‰ â†’ è€ƒè™‘HyperLogLog
- åªæŸ¥è¯¢å½“å¤©æ•°æ® â†’ çº¯Setå³å¯
- å¯¹å†…å­˜éå¸¸æ•æ„Ÿ â†’ è€ƒè™‘é‡‡æ ·æˆ–è¿‘ä¼¼ç®—æ³•

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **æŸ¥è¯¢90å¤©å“åº”æ—¶é—´** | <30ms |
| **å†…å­˜å ç”¨** | <100MBï¼ˆ10ä¸‡UVï¼‰ |
| **ç²¾ç¡®åº¦** | 100%ï¼ˆæ— è¯¯å·®ï¼‰ |
| **æ”¯æŒè·¨å¤©å»é‡** | 7å¤©å†… |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Redis Setå‘½ä»¤æ–‡æ¡£](https://redis.io/commands/?group=set)
- [Redis Hashå‘½ä»¤æ–‡æ¡£](https://redis.io/commands/?group=hash)
- [æ–¹æ¡ˆå¯¹æ¯”è¯¦ç»†æ–‡æ¡£](./UV_SOLUTION_COMPARISON.md)
- [å¼€å‘æŒ‡å—](./STATS_GUIDE.md)
